---
title: "Acute Changes in CEWL as a Function of Temperature: Data Analysis"
author: "Calvin Davis, Savannah Weaver"
date: "2022"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---



# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse") #tidyr, ggplot, dplyr, etc
if (!require("ggpubr")) install.packages("ggpubr") 
library("ggpubr")
if (!require("lme4")) install.packages("lme4") 
library("lme4") # mixed-effect models
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest") # p-values
if (!require("car")) install.packages("car") 
library("car") # test for VIF
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # model export
if (!require("emmeans")) install.packages('emmeans')
library('emmeans')
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer") # model export
if (!require("rmdformats")) install.packages("rmdformats")
library("rmdformats") # clean html R markdown format
```



# Background

This code walks through the statistical models and figures for a study on the rate of change of cutaneous evaporative water loss (CEWL) in response to temperature change in Western Fence Lizards (*Sceloporus occidentalis*). Data was collected and analyzed by Calvin Davis and Savannah Weaver, and the project was advised by Dr. Emily Taylor at California Polytechnic State University. 


# Load Data

Get the RDS files created in the data wrangling Rmd:

```{r}
temp_time_series <- read_rds("Data/temp_time_series.RDS")
CEWL_time_series <- read_rds("Data/CEWL_time_series.RDS") # not needed???
unique(CEWL_time_series$date)

by_minute_indiv <- temp_time_series %>% 
  mutate(time_min_block = floor(time_min)) %>% 
  group_by(date, lizard_ID, treatment, time_min_block) %>% 
  summarise(CEWL_per_min = mean(CEWL_g_m2h),
            clo_temp_per_min = mean(calibrated_cloacal_temp),
            dors_temp_per_min = mean(calibrated_dorsal_temp)) 

by_minute_avg <- by_minute_indiv %>% 
  group_by(treatment, time_min_block) %>% 
  summarise(CEWL_min_avg = mean(CEWL_per_min),
            clo_temp_min_avg = mean(clo_temp_per_min),
            dors_temp_min_avg = mean(dors_temp_per_min))

# start_CEWL_min <- by_minute_indiv %>% 
#   # get starting values only
#   group_by(lizard_ID) %>% 
#   dplyr::filter(time_min_block == 1) %>% 
#   dplyr::select(lizard_ID,
#                 start_CEWL = CEWL_per_min)
# 
# by_minute_relative <- by_minute_indiv %>% 
#   # relativize CEWL to each indiv's starting pt
#   left_join(start_CEWL_min, by = 'lizard_ID') %>% 
#   mutate(relative_CEWL_min = CEWL_per_min - start_CEWL)
```




# Stats & Models


## Temp Correlation

Check the correlation between dorsal and cloacal temps:

*Previously, we ran this regression on the temps recorded every second, but we thought averaging the data by the minute would help reduce any autocorrelation issues.*

```{r temp corr}
temp_corr <- lm(data = by_minute_avg, 
                dors_temp_min_avg ~ clo_temp_min_avg)
summary(temp_corr)
```





## CEWL (raw) ~ temp LMM

First, test linear effects of temperature:

```{r CEWL LMM 2}
CEWL_LMM_02a <- lme4::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             clo_temp_per_min *
                             treatment +
                             (1|date/lizard_ID))

CEWL_LMM_02b <- lme4::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             dors_temp_per_min *
                             treatment +
                             (1|date/lizard_ID))
```

Compare to the inclusion of polynomial factors:

```{r CEWL LMM 3}
CEWL_LMM_03a <- lme4::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             poly(clo_temp_per_min, 2)*treatment +
                             (1|date/lizard_ID))

anova(CEWL_LMM_03a, CEWL_LMM_02a)

CEWL_LMM_03b <- lme4::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             poly(dors_temp_per_min, 2)*treatment +
                             (1|date/lizard_ID))

anova(CEWL_LMM_03b, CEWL_LMM_02b)
```

The poly models have significantly better explanatory power than the linear models.

Also try log transformation to make sure a polynomial effect is best:

```{r CEWL LMM 4}
CEWL_LMM_04a <- lme4::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             (log(clo_temp_per_min))*treatment +
                             (1|date/lizard_ID))

anova(CEWL_LMM_04a, CEWL_LMM_02a)
anova(CEWL_LMM_04a, CEWL_LMM_03a)

CEWL_LMM_04b <- lme4::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             log(dors_temp_per_min)*treatment +
                             treatment +
                             (1|date/lizard_ID))

anova(CEWL_LMM_04b, CEWL_LMM_02b)
anova(CEWL_LMM_04b, CEWL_LMM_03b)
```


The logarithmic models are NOT better than the linear or polynomial ones. **The poly models are best** and the linear and log models are equally less-good. 


Check assumptions:

```{r}
plot(CEWL_LMM_03a)
plot(CEWL_LMM_03b)
vif(CEWL_LMM_03a)
vif(CEWL_LMM_03b)
```

There's no fanning or different pattern. VIF is negligible.

Re-run with p-values:

```{r CEWL LMM best 1}
CEWL_LMM_besta <- lmerTest::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             treatment * poly(clo_temp_per_min, 2) +
                             (1|date/lizard_ID))
summary(CEWL_LMM_besta)
CEWL_clo_anova <- data.frame(anova(CEWL_LMM_besta, type = "2", ddf = "Kenward-Roger")) %>% 
  mutate(variable = row.names(.))

CEWL_LMM_bestb <- lmerTest::lmer(data = by_minute_indiv,
                          CEWL_per_min ~ 
                             treatment * poly(dors_temp_per_min, 2) +
                             (1|date/lizard_ID))
summary(CEWL_LMM_bestb)
CEWL_dors_anova <- data.frame(anova(CEWL_LMM_bestb, type = "2", ddf = "Kenward-Roger")) %>%
  mutate(variable = row.names(.))

# double check sample sizes
temp_time_series %>%
  group_by(lizard_ID, treatment) %>%
  summarise(n()) %>%
  group_by(treatment) %>%
  summarise(n())
```

These are the best models for CEWL ~ temperature. 





Export:

```{r export best CEWL LMM}
# model anovas
CEWL_temp_F_stats <- CEWL_clo_anova %>%
  rbind(CEWL_dors_anova) %>% 
  mutate(partial_sum_of_squares = round(Sum.Sq, 0), 
         F_only = round(F.value, 2),
         DenDF = round(DenDF, 0),
         F_statistic = paste(F_only, " (", NumDF, ",", DenDF, ")", sep = ""),
         p_value = (Pr..F.)) %>%
  dplyr::select(variable,
                partial_sum_of_squares,
                F_statistic, 
                p_value)
write.csv(CEWL_temp_F_stats, 
          "./Results_Statistics/CEWL_temp_F_stats.csv")

# model summaries
broom.mixed::tidy(CEWL_LMM_besta) %>%
  mutate(estimate = round(estimate, digits = 2),
         std.error = round(std.error, digits = 2),
         statistic = round(statistic, digits = 2),
         df = round(df, digits = 0)) %>%
  dplyr::select(effect, group, term, estimate, 
                std.error, statistic, df, p.value) %>%
  write.csv("./Results_Statistics/CEWL_best_model_clotemp.csv")

broom.mixed::tidy(CEWL_LMM_bestb) %>%
  mutate(estimate = round(estimate, digits = 2),
         std.error = round(std.error, digits = 2),
         statistic = round(statistic, digits = 2),
         df = round(df, digits = 0)) %>%
  dplyr::select(effect, group, term, estimate, 
                std.error, statistic, df, p.value) %>%
  write.csv("./Results_Statistics/CEWL_best_model_dorstemp.csv")
```








## CEWL (raw) ~ time LMM

NOTE: Start times vary from 97-170 seconds after starting time series.

Make a polynomial model first:

```{r CEWL time LMM 1}
rates_LMM_01 <- lme4::lmer(data = CEWL_time_series,
                          CEWL_g_m2h ~ 
                             poly(time_min, 2) * treatment +
                             (1|date/lizard_ID))
drop1(rates_LMM_01)
```

Also make a linear model version:

```{r CEWL time LMM 2}
rates_LMM_02 <- lme4::lmer(data = CEWL_time_series,
                          CEWL_g_m2h ~ 
                             time_min * treatment +
                             (1|date/lizard_ID))

anova(rates_LMM_02, rates_LMM_01)
```

Polynomial is much better than linear. 

Also compare to log version:

```{r CEWL time LMM 3}
rates_LMM_03 <- lme4::lmer(data = CEWL_time_series,
                          CEWL_g_m2h ~ 
                             log(time_min) * treatment +
                             (1|date/lizard_ID))

anova(rates_LMM_02, rates_LMM_03)
anova(rates_LMM_01, rates_LMM_03)
```

The polynomial model is best (better than both log and lm options).

Check linear regression assumptions:

```{r}
plot(rates_LMM_01)
vif(rates_LMM_01)
```

Again, there is a really weird spike, but otherwise there's no fanning or pattern.

re-run with p-values:

```{r CEWL LMM best 2}
rates_LMM_best <- lmerTest::lmer(data = CEWL_time_series,
                          CEWL_g_m2h ~ 
                             poly(time_min, 2) * treatment +
                             (1|date/lizard_ID))
summary(rates_LMM_best)
#anova(rates_LMM_best, type = "3", ddf = "Kenward-Roger")

# double check sample sizes
CEWL_time_series %>%
  group_by(lizard_ID, treatment) %>%
  summarise(n()) %>%
  group_by(treatment) %>%
  summarise(n())
```


Export:

```{r}
broom.mixed::tidy(rates_LMM_best) %>%
  mutate(estimate = round(estimate, digits = 2),
         std.error = round(std.error, digits = 2),
         statistic = round(statistic, digits = 2),
         df = round(df, digits = 0)) %>%
  dplyr::select(effect, group, term, estimate, 
                std.error, statistic, df, p.value) %>%
  write.csv("./Results_Statistics/CEWL_best_model_time.csv")
```




## Body Temperature ~ Time

linear models:

```{r temp time LMM 1}
body_temp_LMM_01a <- lme4::lmer(data = temp_time_series,
                          calibrated_cloacal_temp ~ 
                             time_min * treatment +
                             (1|date/lizard_ID))

body_temp_LMM_01b <- lme4::lmer(data = temp_time_series,
                          calibrated_dorsal_temp ~ 
                             time_min * treatment +
                             (1|date/lizard_ID))
```

polynomial models:

```{r temp time LMM 2}
body_temp_LMM_02a <- lme4::lmer(data = temp_time_series,
                          calibrated_cloacal_temp ~ 
                             poly(time_min, 2) * treatment +
                             (1|date/lizard_ID))
anova(body_temp_LMM_02a, body_temp_LMM_01a)

body_temp_LMM_02b <- lme4::lmer(data = temp_time_series,
                          calibrated_dorsal_temp ~ 
                             poly(time_min, 2) * treatment +
                             (1|date/lizard_ID))
anova(body_temp_LMM_02b, body_temp_LMM_01b)
```



Again, the polynomial models are MUCH better.

```{r temp time best}
body_temp_LMM_besta <- lmerTest::lmer(data = temp_time_series,
                          calibrated_cloacal_temp ~ 
                             poly(time_min, 2) * treatment +
                             (1|date/lizard_ID))
summary(body_temp_LMM_besta)
write.csv(broom.mixed::tidy(body_temp_LMM_besta), 
          "./Results_Statistics/temp_time_best_model_clotemp.csv")

body_temp_LMM_bestb <- lmerTest::lmer(data = temp_time_series,
                          calibrated_dorsal_temp ~ 
                             poly(time_min, 2) * treatment +
                             (1|date/lizard_ID))
summary(body_temp_LMM_bestb)
write.csv(broom.mixed::tidy(body_temp_LMM_bestb), 
          "./Results_Statistics/temp_time_best_model_dorstemp.csv")
```




## Rate of Change

We want to know why each lizard had a different rate of change of CEWL during the 15-minute temperature treatment and measurement period.

First, calculate rate of change for each lizard:

```{r CEWL rate of change LM}
change_LM <- lm(data = CEWL_time_series,
                          CEWL_g_m2h ~ 
                             time_min*lizard_ID)
```

Now get the trend/slope for each individual and make into a variable in df.

```{r}
lizard_coeffs <- data.frame(emtrends(change_LM, "lizard_ID", var = "time_min")) %>%
   left_join(read_rds("Data/collection_dat_formatted.RDS"), 
             by = c("lizard_ID" = "individual_ID")) %>%
   dplyr::select(lizard_ID, rate_change = time_min.trend, 
                 SE, df, lower.CL, upper.CL,
                 date,
                 treatment,
                 mass_g, SVL_mm,
                 chamber_time_elapsed_hr
                 ) %>%
   dplyr::mutate(date_factor = as.factor(date))
summary(lizard_coeffs)
length(unique(CEWL_time_series$lizard_ID))
```


Test whether rate of change was sig diff from zero for each tmt group using t-tests:

```{r}
#heating
heat <- lizard_coeffs %>%
  dplyr::filter(treatment == "Heating")
heat_t <- t.test(heat$rate_change, mu = 0, alternative = "two.sided")
heat_t

#cooling
cool <- lizard_coeffs %>%
  dplyr::filter(treatment == "Cooling")
cool_t <- t.test(cool$rate_change, mu = 0, alternative = "two.sided")
cool_t

#control
cntl <- lizard_coeffs %>%
  dplyr::filter(treatment == "Control")
cntl_t <- t.test(cntl$rate_change, mu = 0, alternative = "two.sided")
cntl_t
```


NOW we can look at how the RATE of CEWL change (CEWL change per MINUTE) is different among lizards.

```{r CEWL rate of change LMM 1}
change_LMM_1 <- lme4::lmer(data = lizard_coeffs,
                          rate_change ~ # remember estimate is CEWL PER MINUTE
                             treatment + 
                       mass_g + SVL_mm + 
                       chamber_time_elapsed_hr + 
                  # include date as random effect bc sig diff weather
                       (1|date_factor))

drop1(change_LMM_1)
anova(change_LMM_1)
```

Drop mass first based on low SS and resulting AIC:

```{r CEWL rate of change LMM 2}
change_LMM_2 <- lme4::lmer(data = lizard_coeffs,
                          rate_change ~ # remember estimate is CEWL PER MINUTE
                             treatment + 
                       SVL_mm + 
                       chamber_time_elapsed_hr + 
                  # include date as random effect bc sig diff weather
                       (1|date_factor))
drop1(change_LMM_2)
anova(change_LMM_2)
```



drop SVL:

```{r CEWL rate of change LMM 3}
change_LMM_3 <- lme4::lmer(data = lizard_coeffs,
                          rate_change ~ # remember estimate is CEWL PER MINUTE
                             treatment + 
                             chamber_time_elapsed_hr + 
                  # include date as random effect bc sig diff weather
                       (1|date_factor))
drop1(change_LMM_3)
anova(change_LMM_3)
```


drop chamber_time_elapsed_hr:

```{r CEWL rate of change LMM 4}
change_LMM_4 <- lme4::lmer(data = lizard_coeffs,
                          rate_change ~ 
                             treatment + 
                       (1|date_factor))
drop1(change_LMM_4)
anova(change_LMM_4)
```

The simplest model is our best/final model.

Check assumptions:

```{r}
plot(change_LMM_4)
```

Assumptions look good.

Save with p-values:

```{r best rate of change model}
change_LMM_best <- lmerTest::lmer(data = lizard_coeffs,
                          rate_change ~ # remember estimate is CEWL PER MINUTE
                             treatment + 
                       (1|date_factor))
summary(change_LMM_best)
anova(change_LMM_best, type = "3", ddf = "Kenward-Roger")
```

Treatment group explained a significant amount of the variation (F(3,30)=18.29, p < 0.0001).

Export:

```{r}
broom.mixed::tidy(change_LMM_best) %>%
  mutate(estimate = round(estimate, digits = 2),
         std.error = round(std.error, digits = 2),
         statistic = round(statistic, digits = 2),
         df = round(df, digits = 0)) %>%
  dplyr::select(effect, group, term, estimate, 
                std.error, statistic, df, p.value) %>%
  write.csv("./Results_Statistics/change_CEWL_best_model.csv")
```


also get pairwise differences for change ~ tmt, which I will use to make the boxplot later:

```{r tmt pairwise change}
emmeans <- data.frame(emmeans(change_LMM_best, "treatment"))
emmeans
emmean_ps <- data.frame(pairs(emmeans(change_LMM_best, "treatment"))) # p values
emmean_ps
```





# Figures

## COLOR

```{r}
cool <- c(brewer.pal(11, "RdBu")[c(11)])
heat <- c(brewer.pal(11, "RdBu")[c(2)])
control <- c(brewer.pal(9, "Greys")[c(5)])
cntrls <- c(brewer.pal(9, "Greys")[c(7, 5, 3, 5, 4, 5, 3, 6, 7, 3, 6)])
```


## cloacal temp ~ time

```{r c temp time}
ggplot(temp_time_series) +
   aes(x = time_sec, 
       y = calibrated_cloacal_temp,
       group = lizard_ID,
       color = treatment) +
   # geom_point(size = 0.01, 
   #            alpha = 0.2) +
   # geom_smooth(method = "loess", 
   #             se = F, 
   #             size = 2,
   #             na.rm = TRUE) +
  geom_line() +
   theme_classic() +
   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
   labs(x = "Time (seconds)" , 
        y = "Internal Body Temperature (°C)", 
        color = "Treatment", se = FALSE) -> ctemp_time
ctemp_time
```


## dorsal temp ~ time

```{r d temp time}
ggplot(temp_time_series) +
   aes(x = time_sec, 
       y = (calibrated_dorsal_temp),
       color = treatment) +
   geom_point(size = 0.01, 
              alpha = 0.2) +
   geom_smooth(method = "loess", 
               se = F, 
               size = 2,
               na.rm = TRUE) +
   theme_classic() +
   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
   labs(x= "Time (seconds)" , 
        y= "Surface Body Temperature (°C)", 
        color ="Treatment") -> dtemp_time
dtemp_time
```


## CEWL (raw) ~ time

```{r CEWL time}
ggplot(CEWL_time_series) +
   aes(x= time_sec, 
       y = CEWL_g_m2h,
       color = treatment) +
   geom_point(size = 0.01, 
              alpha = 0.25) +
   geom_smooth(method = "loess", 
               size = 2.5, 
               se = F) +
   theme_classic() +
   theme(text = element_text(size = 15)) + 
   theme(axis.text.x = element_text(size = 10)) +
   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
   labs(x = "Time (seconds)" , 
        y = bquote('CEWL (g/'*m^2*'h)'), 
        color = "Treatment", 
        se = FALSE) +
   scale_x_continuous(limits = c(0, 925), 
                      breaks=seq(0, 950, 100)) -> CEWL_time
CEWL_time
```




## CEWL (MIN) ~ time

```{r CEWL time}
ggplot(CEWL_time_series_minute) +
   aes(x= time_min_block, 
       y = CEWL_min_avg,
       group = treatment,
       color = treatment
       ) +
   geom_point(size = 1, 
              alpha = 0.5) +
  geom_line() +
  geom_smooth(method = "lm",
              se = F) +
   theme_classic() +
   theme(text = element_text(size = 15)) + 
   theme(axis.text.x = element_text(size = 10)) +
   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
   labs(x = "Time (seconds)" , 
        y = bquote('CEWL (g/'*m^2*'h)'), 
        color = "Treatment", 
        se = FALSE)  -> CEWL_time_min
CEWL_time_min
```



## legend

This code uses one of our plots to make a large, detailed legend, which we can save and use in ggarrange later.

```{r make a fancy legend}
ggplot(temp_time_series) +
   
   geom_smooth(aes(x = (calibrated_cloacal_temp), 
       y = CEWL_g_m2h,
       color = treatment),
       method = "lm", 
        formula = y ~ poly(x, 2),
               size = 1, 
               se = F) +
  geom_point(aes(x = (calibrated_cloacal_temp), 
       y = CEWL_g_m2h,
       fill = treatment,
       shape = treatment),
       size = 4, 
       alpha = 1) +
  
  scale_x_continuous(limits = c(14, 39),
                     breaks = c(seq(15, 35, 5)),
                     labels = c(seq(15, 35, 5))) +
  theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = c(0.5,0.5)) +
  scale_shape_manual(values = c(21,25,24),
                     name = "Treatment") +
   scale_fill_manual(values = c("Control" = control,
                                   "Cooling" = cool,  
                                     "Heating" = heat),
                      name = "Treatment") +
  scale_color_manual(values = c("Control" = control,
                                   "Cooling" = cool,  
                                     "Heating" = heat),
                      name = "Treatment")  -> fancy_legend
fancy_legend # view

# save
LEGEND <- as_ggplot(get_legend(fancy_legend)) 

# export
ggsave(filename = "legend_only.pdf",
       plot = LEGEND,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 40, height = 30)
```



## CEWL (raw) ~ cloacal temperature

```{r CEWL cloacal temp}
ggplot(temp_time_series) +
   geom_point(aes(x = (calibrated_cloacal_temp), 
       y = CEWL_g_m2h,
       shape = treatment,
       color = treatment),
       size = 0.01, 
               alpha = 0.1) +
   geom_smooth(aes(x = (calibrated_cloacal_temp), 
       y = CEWL_g_m2h,
       color = treatment),
       method = "lm", 
        formula = y ~ poly(x, 2),
               size = 1.5, 
               se = F) +
  scale_x_continuous(limits = c(12.5, 40),
                     breaks = c(seq(15, 35, 5)),
                     labels = c(seq(15, 35, 5))) +

  # annotations for cooling group
   annotate(geom = "point", x = 14.3, y = 5, 
           size = 4, pch = 25, fill = cool) + 
   annotate("text", x = 12.6, y = 5, label = "T[15]", parse = T,
           size = 5, family = "sans", color = cool) +
   annotate(geom = "point", x = 35.2, y = 11.8, 
           size = 4, pch = 25, fill = cool) + 
   annotate("text", x = 36.7, y = 11.8, label = "T[1]", parse = T,
           size = 5, family = "sans", color = cool) +
  
  # annotations for heating group
   annotate(geom = "point", x = 15.9, y = 14, 
           size = 4, pch = 24, fill = heat) +  
   annotate("text", x = 14.3, y = 14, label = "T[1]", parse = T,
           size = 5, family = "sans", color = heat) +
   annotate(geom = "point", x = 38.3, y = 25.2, 
           size = 4, pch = 24, fill = heat) +
   annotate("text", x = 40, y = 25.2, label = "T[15]", parse = T,
           size = 5, family = "sans", color = heat) +
   
   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = "none",
        plot.margin = margin(t = 6, r = 6, b = 6, l = 6, unit = "pt")) +
  
   scale_color_manual(values = c("Control" = control,
                                   "Cooling" = cool,  
                                     "Heating" = heat),
                      name = "Treatment") +
  scale_shape_manual(values = c(21,25,24),
                     name = "Treatment") + 
  
   labs(x = "Internal Body Temperature (°C)" , 
        y = bquote('CEWL (g '*m^-2*' '*h^-1*')'), 
        se = FALSE) -> CEWL_ctemp
CEWL_ctemp

# save
ggsave(filename = "CEWL_int_body_temp.pdf",
       plot = CEWL_ctemp,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 150, height = 100)
```




## CEWL (MIN) ~ cloacal temperature

```{r CEWL cloacal temp}
ggplot(by_minute_indiv) +
  aes(
    x = clo_temp_per_min,
    y = CEWL_per_min,
    group = lizard_ID,
    shape = treatment,
    color = treatment
  ) +
  geom_point(size = 1, 
               alpha = 0.8) +
  geom_line() +
  scale_x_continuous(limits = c(12.5, 40),
                     breaks = c(seq(15, 35, 5)),
                     labels = c(seq(15, 35, 5))) +

   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = "none",
        plot.margin = margin(t = 6, r = 6, b = 6, l = 6, unit = "pt")) +
  
   scale_color_manual(values = c("Control" = control,
                                   "Cooling" = cool,  
                                     "Heating" = heat),
                      name = "Treatment") +
  scale_shape_manual(values = c(21,25,24),
                     name = "Treatment") + 
  
   labs(x = "Internal Body Temperature (°C)" , 
        y = bquote('CEWL (g '*m^-2*' '*h^-1*')'), 
        se = FALSE)
```



## CEWL (MIN avg) ~ cloacal temperature

```{r CEWL cloacal temp}
ggplot(by_minute_avg) +
  aes(
    x = clo_temp_min_avg,
    y = CEWL_min_avg,
    #group = lizard_ID,
    shape = treatment,
    color = treatment
  ) +
   geom_point(size = 1, 
               alpha = 0.8) +
  geom_line() +
   geom_smooth(method = "lm",
        #formula = y ~ poly(x, 2),
               size = 1.5,
               se = F) +
  scale_x_continuous(limits = c(12.5, 40),
                     breaks = c(seq(15, 35, 5)),
                     labels = c(seq(15, 35, 5))) +

   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = "none",
        plot.margin = margin(t = 6, r = 6, b = 6, l = 6, unit = "pt")) +
  
   scale_color_manual(values = c("Control" = control,
                                   "Cooling" = cool,  
                                     "Heating" = heat),
                      name = "Treatment") +
  scale_shape_manual(values = c(21,25,24),
                     name = "Treatment") + 
  
   labs(x = "Internal Body Temperature (°C)" , 
        y = bquote('CEWL (g '*m^-2*' '*h^-1*')'), 
        se = FALSE)
```



















## CEWL Control

```{r CEWL ~ CONTRL temp by individual}
# get control data only
temp_time_series %>%
  dplyr::filter(treatment == "Control") %>%
  # pipe into ggplot
  ggplot() +
   aes(x = calibrated_cloacal_temp, 
       y = CEWL_g_m2h,
       color = lizard_ID) +
  
   geom_point(size = 0.1, 
               alpha = 0.1) +
   geom_smooth(method = "lm", 
               size = 1, 
               se = F) +

   ylim(0,32) +
   xlim(25,31) +
  
   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = "none",
        plot.margin = margin(t = 6, r = 6, b = 6, l = 6, unit = "pt")) +
  
   scale_color_manual(values = cntrls) +
  
   labs(x = "Internal Body Temperature (°C)" , 
        y = bquote('CEWL (g '*m^-2*' '*h^-1*')'), 
        color = "Treatment", 
        se = FALSE) -> CEWL_control
CEWL_control

# save
ggsave(filename = "CEWL_temp_control_lm.pdf",
       plot = CEWL_control,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 60)
```




## CEWL (relative) ~ time


```{r relative CEWL time}
# check n lizard sample size
CEWL_time_series %>%
  dplyr::filter(complete.cases(time_min, relative_CEWL)) %>%
  group_by(lizard_ID) %>%
  summarise(max(relative_CEWL)) %>%
  nrow()

# plot
ggplot() +
   geom_point(data = CEWL_time_series,
              aes(x= time_min, 
                  y = relative_CEWL,
                  shape = treatment,
                  color = treatment),
              size = 0.01, 
              alpha = 0.1) +
  
   geom_hline(yintercept = 0, size = 0.5,
              linetype = "dashed", color = "black") +
   
   geom_smooth(data = CEWL_time_series,
               aes(x = time_min, 
                   y = relative_CEWL,
                   color = treatment),
               method = "lm", 
               formula = y ~ poly((x), 2),
               size = 1.5, 
               se = F) +
   
   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = "none") +
  
  scale_shape_manual(values = c(21,25,24),
                     name = "Treatment") + 
   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat),
                      name = "Treatment") +
  
  annotate(geom = "point", x = 15, y = -3.9, 
           size = 4, pch = 21, fill = control) +
   annotate(geom = "point", x = 15, y = -7.5, 
           size = 4, pch = 25, fill = cool) + 
   annotate(geom = "point", x = 15, y = 3, 
           size = 4, pch = 24, fill = heat) +
  scale_x_continuous(limits = c(1, 15), 
                      breaks = seq(1, 15, 2)) +

   labs(x = "Time (minutes)" , 
        y = bquote('Relative CEWL (g '*m^-2*' '*h^-1*')')) -> CEWLr_time
  
CEWLr_time

# save
ggsave(filename = "CEWL_relative_time.pdf",
       plot = CEWLr_time,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 150, height = 100)
```






## CEWL Rate of Change

```{r rate of change fig}
ggplot() +
  geom_jitter(data = lizard_coeffs,
              aes(x = treatment,
                   y = rate_change,
                   shape = treatment,
                   color = treatment,
                   fill = treatment),
                   size = 0.8,
               alpha = 0.3,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_errorbar(data = emmeans,
                aes(x = treatment,
                    y = emmean, 
                    color = treatment,
                    group = treatment,
                    ymin = lower.CL, 
                    ymax = upper.CL),
                width = .1,
                alpha = 0.9) +
  geom_point(data = emmeans, 
             aes(x = treatment,
                   y = emmean, 
                 shape = treatment,
                 fill = treatment), 
              color = "black",
              size = 4) +
   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = "none") +
  
   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
  scale_fill_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
  
  scale_shape_manual(values = c(21,25,24),
                     name = "Treatment") + 
  
   geom_hline(yintercept = 0, size = 0.5,
              linetype = "dashed", color = "black") +
  
   annotate("text", x = 1, y = 0.42, label = "A", size = 3) +
   annotate("text", x = 2, y = 0.3, label = "A", size = 3) +
   annotate("text", x = 3, y = 0.9, label = "B", size = 3) +
  
   labs(x = "" , 
        y = expression(Delta ~ 'CEWL '*min^-1*''),
        color = "Treatment") -> rate_change_CEWL_fig
rate_change_CEWL_fig

# save
ggsave(filename = "CEWL_change_min.pdf",
       plot = rate_change_CEWL_fig,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 60)
```


## Experimental Design Skematic

We created reference values to use to make a figure that would show each step of our experiment. 

```{r load exp design values}
exp_design <- read.csv("./Data/exp design.csv", 
                            header = TRUE,
                            fileEncoding="UTF-8-BOM")
```

```{r make exp design figure}
ggplot(exp_design) +
   aes(x = time_min, 
       y = temp_C,
       color = treatment) +
     geom_line(size = 1) +
   geom_vline(xintercept = 60,
              alpha = 0.5,
              size = 0.5,
              linetype = "dashed", color = "black") +
   geom_text(aes(30, 37, family = "sans"), label = "a", color = "black", size = 3) +
   geom_vline(xintercept = 65,
              alpha = 0.5,
              size = 0.5,
              linetype = "dashed", color = "black") +
   geom_text(aes(62.5, 37, family = "sans"), label = "b", color = "black", size = 3) +
   geom_vline(xintercept = 80,
              alpha = 0.5,
              size = 0.5,
              linetype = "dashed", color = "black") +
   geom_text(aes(72.5, 37, family = "sans"), label = "c", color = "black", size = 3) +
   theme_classic() +
   theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 8),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.position = "none",
        axis.text.x = element_blank(),
        #axis.line.x = element_blank(),
        axis.ticks.x = element_blank()) +

   scale_color_manual(values = c("Control" = control,
                                     "Cooling" = cool,  
                                     "Heating" = heat)) +
   labs(x = "Time" , 
        y = "Body Temperature (°C)", 
        color = "Treatment") +
   
    annotate(geom = "point", x = 80, y = 25, 
           size = 3, pch = 21, fill = control) +
   annotate(geom = "point", x = 80, y = 20, 
           size = 3, pch = 25, fill = cool) + 
   annotate(geom = "point", x = 80, y = 30, 
           size = 3, pch = 24, fill = heat) +
   
   scale_y_continuous(limits = c(14, 37), 
                      breaks=seq(15, 35, 5)) -> methods_schmatic_fig
methods_schmatic_fig

# save
ggsave(filename = "methods_schematic.pdf",
       plot = methods_schmatic_fig,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 60)
```
 

# Save Grouped Figures


## Relative CEWL & Rate of Change

```{r}
multi_fig_relative <- ggarrange(CEWLr_time, 
          ggarrange(rate_change_CEWL_fig, LEGEND, 
                    nrow = 1, ncol = 2,
                    widths = c(2,1),
                    align = "hv"
                    ),
          nrow = 2, ncol = 1,
          heights = c(2,1),
          labels = c("A", "B"))
multi_fig_relative

ggsave(filename = "CEWL_time_multi_fig.pdf",
       plot = multi_fig_relative,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 120, height = 160)
```

## Raw CEWL ~ Cloacal temp & control zoom-in

```{r}
multi_fig_CEWL_by_temp <- ggarrange(CEWL_ctemp, 
                  ggarrange(CEWL_control, LEGEND, 
                            nrow = 1, ncol = 2,
                            widths = c(2, 1),
                            align = "hv"
                            ),
                  nrow = 2, ncol = 1,
                  heights = c(2,1),
          labels = c("A", "B"))
multi_fig_CEWL_by_temp

ggsave(filename = "CEWL_temp_multi_fig.pdf",
       plot = multi_fig_CEWL_by_temp,
       path = "./Results_Figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 120, height = 160)
```
